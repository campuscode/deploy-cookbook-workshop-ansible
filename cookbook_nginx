upstream cookbook {
  {% for server in groups['web'] %}
  server {{ server }}:3000;
  {% endfor %}
}

server {
  server_name {{ cookbook_host }};

  root {{ cookbook_home_dir }}/public;
  listen 80;
  client_max_body_size 4G;

  proxy_buffering on;
  proxy_buffer_size 128k;
  proxy_buffers 4 256k;
  keepalive_requests 50;
  keepalive_timeout 10;

  access_log   /var/log/nginx/cookbook.log combined;
  error_log    /var/log/nginx/cookbook_error.log error;

  location / {
    try_files $uri @cookbook;
  }

  location @cookbook {
    proxy_set_header X-Real-IP              $remote_addr;
    proxy_set_header X-Forwarded-For        $proxy_add_x_forwarded_for;
    proxy_set_header Host                   $http_host;
    proxy_redirect                          off;
    proxy_pass http://cookbook;
    proxy_cache_valid 200 1s;
    proxy_cache_key $scheme$host%request_method$request_uri;
    proxy_cache_use_stale updating;
    proxy_max_temp_file_size 1M;
    proxy_intercept_errors on;
  }

  location ~ ^/public/ {
    expires 1y;
    add_header Cache-Control public;
    add_header Etag “”;
    break;
  }

  error_page 400 404 /404.html;
  location = /404.html {
    root {{ cookbook_home_dir }}/public;
  }

  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root {{ cookbook_home_dir }}/public;
  }

  location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
  }

  location ~ \.(aspx|php|jsp|cgi)$ {
    try_files $uri =410;
    break;
  }
}

# vim: ft=nginx
